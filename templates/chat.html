{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ other.username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #efeae2; font-family: -apple-system, sans-serif; }
        .chat-wrapper { max-width: 600px; margin: 20px auto; height: 90vh; display: flex; flex-direction: column; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chat-header { background-color: #008069; color: white; padding: 10px 15px; display: flex; align-items: center; }
        .avatar { width: 40px; height: 40px; background-color: #dfe5e7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #54656f; margin-right: 12px; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; background-color: #efeae2; display: flex; flex-direction: column; }
        .message { margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 0.95rem; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); position: relative; }
        .sent { background-color: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        .received { background-color: #ffffff; align-self: flex-start; border-top-left-radius: 0; }
        .msg-footer { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 0.7rem; color: #667781; margin-top: 4px; }
        .tick-icon { display: flex; align-items: center; }
        .input-area { background-color: #f0f2f5; padding: 10px; display: flex; align-items: center; }
        #chat-message-input { border-radius: 20px; border: none; padding: 10px 20px; flex-grow: 1; outline: none; }
        #chat-message-submit { background-color: #00a884; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="chat-wrapper">
    <div class="chat-header">
        <a href="{% url 'user_list' %}" class="text-white text-decoration-none me-3">←</a>
        <div class="avatar">{{ other.username|first|upper }}</div>
        <div class="flex-grow-1">
            <div class="fw-bold">{{ other.username }}</div>
            <small id="user-status">{% if other.is_online %}<span class="text-info">● online</span>{% else %}offline{% endif %}</small>
            <small id="typing-text" class="ms-1"></small>
        </div>
    </div>

    <div id="chat-log">
        {% for message in chat_messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                {{ message.content }}
                <div class="msg-footer">
                    <span>{{ message.timestamp|date:"H:i" }}</span>
                    {% if message.sender == request.user %}
                        <span class="tick-icon" id="tick-{{ message.id }}">
                            {% if message.is_read %}
                                <svg width="18" height="11" fill="none"><path d="M15 2L9 11L6.5 8.5M10.5 2L4.5 11L1 7.5" stroke="#34B7F1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            {% else %}
                                <svg width="18" height="11" fill="none"><path d="M15 2L9 11L6.5 8.5M10.5 2L4.5 11L1 7.5" stroke="#8696a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="input-area">
        <input id="chat-message-input" type="text" placeholder="Type a message...">
        <button id="chat-message-submit">➤</button>
    </div>
</div>

<script>
    const otherUser = "{{ other.username }}";
    const me = "{{ request.user.username }}";
    const chatLog = document.querySelector('#chat-log');
    const msgInput = document.querySelector('#chat-message-input');
    const chatSocket = new WebSocket((window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/' + otherUser + '/');

    chatLog.scrollTop = chatLog.scrollHeight;

    chatSocket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === 'message_handler') {
            const div = document.createElement('div');
            div.className = `message ${data.sender === me ? 'sent' : 'received'}`;
            let tick = data.sender === me ? `<span class="tick-icon" id="tick-${data.message_id}"><svg width="12" height="11" fill="none"><path d="M1 8L5 12L15 2" stroke="#8696a0" stroke-width="2"/></svg></span>` : '';
            div.innerHTML = `${data.message} <div class="msg-footer"><span>${data.timestamp}</span>${tick}</div>`;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        } 
        else if (data.action === 'delivered_confirmed') {
            const el = document.querySelector(`#tick-${data.message_id}`);
            if (el) el.innerHTML = '<svg width="18" height="11" fill="none"><path d="M15 2L9 11L6.5 8.5M10.5 2L4.5 11L1 7.5" stroke="#8696a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        } 
        else if (data.action === 'read_confirmed' && data.reader !== me) {
            document.querySelectorAll('.sent .tick-icon').forEach(i => {
                i.innerHTML = '<svg width="18" height="11" fill="none"><path d="M15 2L9 11L6.5 8.5M10.5 2L4.5 11L1 7.5" stroke="#34B7F1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            });
        } 
        else if (data.action === 'typing' && data.username !== me) {
            document.querySelector('#typing-text').innerText = data.is_typing ? "typing..." : "";
        }
    };

    document.querySelector('#chat-message-submit').onclick = () => {
        if(msgInput.value.trim()){
            chatSocket.send(JSON.stringify({'action': 'message', 'message': msgInput.value}));
            msgInput.value = '';
            chatSocket.send(JSON.stringify({'action': 'typing', 'typing': false}));
        }
    };

    msgInput.oninput = () => {
        chatSocket.send(JSON.stringify({'action': 'typing', 'typing': true}));
        clearTimeout(window.t);
        window.t = setTimeout(() => chatSocket.send(JSON.stringify({'action': 'typing', 'typing': false})), 1500);
    };
</script>
</body>
</html> 

